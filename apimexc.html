<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trading Advisor Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .control-group input,
        .control-group select {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .api-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .api-type-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .api-type-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            display: none;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .trading-info {
            margin: 30px 0;
        }

        .trading-info label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .trading-info textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .trading-info textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .data-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .data-section h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
        }

        .data-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid #dee2e6;
            max-height: 400px;
            overflow-y: auto;
        }

        .copy-btn {
            margin-top: 15px;
            background: #17a2b8;
            color: white;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            /* margin: 20px 0; */
            padding: 15px;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(40, 167, 69, 0.2);
            margin-left: auto; /* ƒë·∫©y sang ph·∫£i */
        }

        .auto-refresh input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .auto-refresh label {
            font-weight: 600;
            color: #333;
        }

        .refresh-interval {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-interval select {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        /* New styles for advice options */
        .advice-options {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .advice-options h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .advice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .advice-option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .advice-option:hover {
            border-color: #ffc107;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
        }

        .advice-option.selected {
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }

        .advice-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            transition: all 0.3s ease;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .advice-option.selected .advice-checkbox {
            background: #ffc107;
            border-color: #ffc107;
        }

        .advice-checkbox::after {
            content: '‚úì';
            color: white;
            font-weight: bold;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .advice-option.selected .advice-checkbox::after {
            opacity: 1;
        }

        .advice-text {
            flex: 1;
        }

        .advice-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .advice-description {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .select-all-btn {
            margin-bottom: 15px;
            padding: 8px 16px;
            font-size: 14px;
            background: #ffc107;
            color: #333;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .select-all-btn:hover {
            background: #ffca2c;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .controls {
                grid-template-columns: 1fr;
            }

            .buttons {
                flex-direction: column;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .right-panel {
                position: static;
                max-height: none;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Crypto Trading Advisor Tool</h1>
            <p>Thu th·∫≠p d·ªØ li·ªáu v√† t·∫°o prompt cho chatbot t∆∞ v·∫•n trade</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>API Type:</label>
                <div class="api-type-selector">
                    <div class="api-type-btn" data-type="spot">Spot</div>
                    <div class="api-type-btn active" data-type="futures">Futures</div>
                </div>
            </div>

            <div class="control-group">
                <label for="coinSymbol">Coin Symbol:</label>
                <input type="text" id="coinSymbol" value="BTCUSDT" placeholder="VD: BTCUSDT">
            </div>

            <div class="control-group">
                <label for="timeframe">Khung th·ªùi gian:</label>
                <select id="timeframe">
                    <option value="1m">1 ph√∫t</option>
                    <option value="5m">5 ph√∫t</option>
                    <option value="15m">15 ph√∫t</option>
                    <option value="30m">30 ph√∫t</option>
                    <option value="1h" selected>1 gi·ªù</option>
                    <option value="4h">4 gi·ªù</option>
                    <option value="1d">1 ng√†y</option>
                    <option value="1w">1 tu·∫ßn</option>
                </select>
            </div>

            <div class="control-group">
                <label for="candleLimit">S·ªë n·∫øn:</label>
                <input type="number" id="candleLimit" value="50" min="1" max="1000">
            </div>
        </div>

        <div class="buttons">
            <button class="btn btn-primary" onclick="fetchCandleData()">
                üìä L·∫•y d·ªØ li·ªáu n·∫øn
            </button>
            <button class="btn btn-secondary" onclick="refreshData()">
                üîÑ Refresh
            </button>
            <button class="btn btn-success" onclick="copyAllData()">
                üìã Copy t·∫•t c·∫£
            </button>

            <div class="auto-refresh">
                <input type="checkbox" id="autoRefresh">
                <label for="autoRefresh">Auto Refresh</label>
                <div class="refresh-interval">
                    <span>Interval:</span>
                    <select id="refreshInterval">
                        <option value="30">30s</option>
                        <option value="60" selected>1 ph√∫t</option>
                        <option value="300">5 ph√∫t</option>
                        <option value="600">10 ph√∫t</option>
                    </select>
                </div>
            </div>
            
        </div>

        <div class="status" id="status"></div>

        <!-- Advice Options Section -->
        <div class="advice-options">
            <h4>ü§ñ Ch·ªçn c√¢u h·ªèi t∆∞ v·∫•n cho ChatBot</h4>
            <button id="selectAllBtn" class="select-all-btn" onclick="toggleSelectAll()">Ch·ªçn t·∫•t c·∫£</button>
            <div class="advice-grid" id="adviceGrid"></div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="trading-info">
                    <label for="tradingDraft">üìù Nh√°p th√¥ng tin trading:</label>
                    <textarea id="tradingDraft" placeholder="Vi·∫øt nh√°p th√¥ng tin trading t·∫°i ƒë√¢y... 
VD: Long BTC t·∫°i 45000, TP 46000, SL 44000
Entry: 45000-45200
Risk: 2% portfolio
Timeframe: 1H" style="min-height: 100px;"></textarea>
                    <button class="btn btn-secondary" onclick="copyDraftToTrading()"
                        style="margin-top: 10px; font-size: 14px;">
                        ‚û°Ô∏è Copy v√†o th√¥ng tin trading ch√≠nh
                    </button>
                </div>

                <div class="trading-info">
                    <label for="tradingContext">üìã Th√¥ng tin trading c·ªßa b·∫°n:</label>
                    <textarea id="tradingContext"
                        placeholder="VD: Hi·ªán t·∫°i ƒëang c√≥ m·ªôt l·ªánh long t·∫°i gi√° 45000 c√≥ TP l√† 46000 v√† SL l√† 44000. H√£y ki·ªÉm tra bi·ªÉu ƒë·ªì v√† t∆∞ v·∫•n t√¥i c√≥ c·∫ßn thay ƒë·ªïi ho·∫∑c v√†o th√™m l·ªánh kh√°c kh√¥ng?"></textarea>
                </div>

                <div class="trading-info">
                    <label for="manualData">üìù D·ªØ li·ªáu n·∫øn th·ªß c√¥ng (n·∫øu API kh√¥ng ho·∫°t ƒë·ªông):</label>
                    <textarea id="manualData" placeholder="Paste d·ªØ li·ªáu JSON t·ª´ MEXC API tr·ª±c ti·∫øp t·∫°i ƒë√¢y...

üìä FUTURES FORMAT (nh∆∞ b·∫°n ƒë√£ paste):
{&quot;success&quot;:true,&quot;code&quot;:0,&quot;data&quot;:{&quot;time&quot;:[1756173600,1756177200,...],&quot;open&quot;:[109853.2,109668.7,...],...}}

üìà SPOT FORMAT:
[[1634025600000,45000,46000,44500,45500,1000],[1634029200000,45500,45800,45200,45600,900],...]

üí° H∆∞·ªõng d·∫´n: Copy URL API ‚Üí Paste v√†o tr√¨nh duy·ªát ‚Üí Copy k·∫øt qu·∫£ ‚Üí Paste v√†o ƒë√¢y"
                        style="min-height: 100px; font-family: 'Courier New', monospace; font-size: 12px;"></textarea>
                    <button class="btn btn-secondary" onclick="processManualData()" style="margin-top: 10px;">
                        üìä X·ª≠ l√Ω d·ªØ li·ªáu th·ªß c√¥ng
                    </button>
                </div>

                <div class="data-section" style="background: #fff3cd; border-color: #ffeaa7;">
                    <h3 style="color: #856404;">üí° H∆∞·ªõng d·∫´n kh·∫Øc ph·ª•c l·ªói API</h3>
                    <div style="color: #856404; line-height: 1.6;">
                        <p><strong>N·∫øu g·∫∑p l·ªói "Failed to fetch" ho·∫∑c CORS:</strong></p>
                        <ol>
                            <li><strong>C√°ch 1:</strong> Copy URL API t·ª´ console v√† paste v√†o tr√¨nh duy·ªát m·ªõi</li>
                            <li><strong>C√°ch 2:</strong> Copy k·∫øt qu·∫£ JSON t·ª´ tr√¨nh duy·ªát v√† paste v√†o "D·ªØ li·ªáu n·∫øn th·ªß
                                c√¥ng"</li>
                            <li><strong>C√°ch 3:</strong> Th·ª≠ ƒë·ªïi API Type (Spot ‚Üî Futures)</li>
                            <li><strong>C√°ch 4:</strong> Th·ª≠ symbol kh√°c (VD: ETHUSDT, BNBUSDT)</li>
                        </ol>
                        <p><strong>L∆∞u √Ω:</strong> L·ªói n√†y do ch√≠nh s√°ch CORS c·ªßa tr√¨nh duy·ªát, kh√¥ng ph·∫£i l·ªói code.</p>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="data-display" id="dataDisplay" style="display: none;">
                    <div class="data-section">
                        <h3>üìà D·ªØ li·ªáu n·∫øn (Candlestick Data)</h3>
                        <div class="data-content" id="candleData"></div>
                        <button class="btn copy-btn" onclick="copyData('candleData')">üìã Copy d·ªØ li·ªáu n·∫øn</button>
                    </div>

                    <div class="data-section">
                        <h3>ü§ñ Prompt cho ChatBot</h3>
                        <div class="data-content" id="chatbotPrompt"></div>
                        <button class="btn copy-btn" onclick="copyData('chatbotPrompt')">üìã Copy prompt</button>
                    </div>
                </div>

                <div id="noDataMessage" class="data-section" style="text-align: center; color: #6c757d;">
                    <h3>üìä D·ªØ li·ªáu s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y</h3>
                    <p>Click "L·∫•y d·ªØ li·ªáu n·∫øn" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshTimer = null;

        function getCurrentApiType() {
            const activeBtn = document.querySelector(".api-type-btn.active");
            return activeBtn ? activeBtn.dataset.type : "futures";
        }

        // Auto refresh functionality
        document.getElementById('autoRefresh').addEventListener('change', function () {
            if (this.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });

        function startAutoRefresh() {
            const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;
            autoRefreshTimer = setInterval(() => {
                refreshData();
            }, interval);
        }

        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
        }

        function showStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }

        function getTimeframeForApi(timeframe, apiType) {
            if (apiType === 'futures') {
                const futuresMap = {
                    '1m': 'Min1',
                    '5m': 'Min5',
                    '15m': 'Min15',
                    '30m': 'Min30',
                    '1h': 'Min60',
                    '4h': 'H4',
                    '1d': 'Day1',
                    '1w': 'Week1'
                };
                return futuresMap[timeframe] || 'Min60';
            }
            return timeframe;
        }

        function getCoinSymbolForApi(symbol, apiType) {
            if (apiType === 'futures') {
                return symbol.replace('USDT', '_USDT');
            }
            return symbol;
        }

        async function fetchCandleData() {
            const symbol = document.getElementById('coinSymbol').value.toUpperCase();
            const timeframe = document.getElementById('timeframe').value;
            const limit = document.getElementById('candleLimit').value;

            if (!symbol) {
                showStatus('Vui l√≤ng nh·∫≠p symbol coin!', 'error');
                return;
            }

            showStatus('üîÑ ƒêang l·∫•y d·ªØ li·ªáu...', 'loading');

            try {
                const apiTimeframe = getTimeframeForApi(timeframe, getCurrentApiType());
                const apiSymbol = getCoinSymbolForApi(symbol, getCurrentApiType());

                let apiUrl;
                if (getCurrentApiType() === 'futures') {
                    apiUrl = `https://contract.mexc.com/api/v1/contract/kline/${apiSymbol}?interval=${apiTimeframe}&limit=${limit}`;
                } else {
                    apiUrl = `https://api.mexc.com/api/v3/klines?symbol=${apiSymbol}&interval=${timeframe}&limit=${limit}`;
                }

                console.log('Original API URL:', apiUrl);

                // Danh s√°ch c√°c proxy CORS ƒë·ªÉ th·ª≠
                const corsProxies = [
                    'https://cors-anywhere.herokuapp.com/',
                    'https://api.allorigins.win/raw?url=',
                    'https://corsproxy.io/?',
                    'https://api.codetabs.com/v1/proxy?quest='
                ];

                let data = null;
                let lastError = null;

                // Th·ª≠ g·ªçi tr·ª±c ti·∫øp tr∆∞·ªõc
                try {
                    console.log('Trying direct API call...');
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Origin': window.location.origin
                        }
                    });

                    if (response.ok) {
                        data = await response.json();
                        console.log('Direct API call successful:', data);
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.log('Direct API call failed:', error.message);
                    lastError = error;

                    // N·∫øu g·ªçi tr·ª±c ti·∫øp th·∫•t b·∫°i, th·ª≠ c√°c proxy
                    for (let i = 0; i < corsProxies.length; i++) {
                        try {
                            const proxyUrl = corsProxies[i] + encodeURIComponent(apiUrl);
                            console.log(`Trying proxy ${i + 1}:`, proxyUrl);

                            const response = await fetch(proxyUrl, {
                                method: 'GET',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            });

                            if (response.ok) {
                                const responseText = await response.text();
                                try {
                                    data = JSON.parse(responseText);
                                    console.log(`Proxy ${i + 1} successful:`, data);
                                    break;
                                } catch (parseError) {
                                    // N·∫øu response kh√¥ng ph·∫£i JSON, c√≥ th·ªÉ l√† HTML error page
                                    throw new Error('Invalid JSON response from proxy');
                                }
                            } else {
                                throw new Error(`Proxy HTTP ${response.status}: ${response.statusText}`);
                            }
                        } catch (proxyError) {
                            console.log(`Proxy ${i + 1} failed:`, proxyError.message);
                            lastError = proxyError;
                            continue;
                        }
                    }
                }

                if (!data) {
                    throw new Error(`Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ API. L·ªói cu·ªëi: ${lastError?.message || 'Unknown error'}\n\nG·ª£i √Ω: B·∫°n c√≥ th·ªÉ th·ª≠:\n1. Copy URL sau v√†o tr√¨nh duy·ªát: ${apiUrl}\n2. T·ª± nh·∫≠p d·ªØ li·ªáu v√†o v√πng "D·ªØ li·ªáu n·∫øn th·ªß c√¥ng" b√™n d∆∞·ªõi`);
                }

                if (Array.isArray(data) && data.length === 0) {
                    throw new Error('API tr·∫£ v·ªÅ d·ªØ li·ªáu r·ªóng - c√≥ th·ªÉ symbol kh√¥ng ƒë√∫ng');
                }

                const candleData = processCandleData(data, getCurrentApiType());
                displayData(candleData, symbol, timeframe, limit);

                showStatus('‚úÖ L·∫•y d·ªØ li·ªáu th√†nh c√¥ng!', 'success');
                setTimeout(hideStatus, 3000);

            } catch (error) {
                console.error('Error:', error);
                showStatus(`‚ùå ${error.message}`, 'error');
            }
        }

        function processCandleData(data, apiType) {
            let candles = [];

            if (apiType === 'futures') {
                // MEXC Futures API returns data in object format with separate arrays
                if (data.success && data.data) {
                    const klineData = data.data;
                    // Check if we have the required arrays
                    if (klineData.time && klineData.open && klineData.high && klineData.low && klineData.close && klineData.vol) {
                        // Combine the arrays into candlestick format
                        for (let i = 0; i < klineData.time.length; i++) {
                            candles.push({
                                time: new Date(klineData.time[i] * 1000).toLocaleString('vi-VN'),
                                timestamp: klineData.time[i] * 1000,
                                open: parseFloat(klineData.open[i]),
                                high: parseFloat(klineData.high[i]),
                                low: parseFloat(klineData.low[i]),
                                close: parseFloat(klineData.close[i]),
                                volume: parseFloat(klineData.vol[i])
                            });
                        }
                    } else {
                        throw new Error('D·ªØ li·ªáu Futures kh√¥ng c√≥ ƒë·ªß th√¥ng tin c·∫ßn thi·∫øt');
                    }
                } else if (Array.isArray(data)) {
                    // Fallback: if data is array format
                    candles = data.map(candle => ({
                        time: new Date(candle[0] * 1000).toLocaleString('vi-VN'),
                        timestamp: candle[0] * 1000,
                        open: parseFloat(candle[1]),
                        high: parseFloat(candle[2]),
                        low: parseFloat(candle[3]),
                        close: parseFloat(candle[4]),
                        volume: parseFloat(candle[5])
                    }));
                } else {
                    throw new Error('Format d·ªØ li·ªáu Futures kh√¥ng ƒë√∫ng');
                }
            } else {
                // Spot API - returns array format
                if (Array.isArray(data)) {
                    candles = data.map(candle => ({
                        time: new Date(parseInt(candle[0])).toLocaleString('vi-VN'),
                        timestamp: parseInt(candle[0]),
                        open: parseFloat(candle[1]),
                        high: parseFloat(candle[2]),
                        low: parseFloat(candle[3]),
                        close: parseFloat(candle[4]),
                        volume: parseFloat(candle[5])
                    }));
                } else {
                    throw new Error('Format d·ªØ li·ªáu Spot kh√¥ng ƒë√∫ng');
                }
            }

            // Sort from old to new (futures data is already in correct order)
            if (apiType === 'spot') {
                candles.reverse();
            }

            return candles;
        }

        function copyDraftToTrading() {
            const draftContent = document.getElementById('tradingDraft').value;
            if (!draftContent.trim()) {
                showStatus('Vui l√≤ng nh·∫≠p n·ªôi dung nh√°p tr∆∞·ªõc!', 'error');
                setTimeout(hideStatus, 2000);
                return;
            }

            document.getElementById('tradingContext').value = draftContent;
            showStatus('‚úÖ ƒê√£ copy nh√°p v√†o th√¥ng tin trading ch√≠nh!', 'success');
            setTimeout(hideStatus, 2000);
        }

        function displayData(candleData, symbol, timeframe, limit) {
            // ·∫®n th√¥ng b√°o "no data" v√† hi·ªÉn th·ªã data display
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('dataDisplay').style.display = 'block';

            const currentPrice = candleData[candleData.length - 1].close;
            const prevPrice = candleData[candleData.length - 2]?.close || currentPrice;
            const priceChange = ((currentPrice - prevPrice) / prevPrice * 100).toFixed(2);

            // Hi·ªÉn th·ªã d·ªØ li·ªáu n·∫øn
            let candleDisplay = `D·ªØ li·ªáu n·∫øn cho ${symbol} - Khung ${timeframe} (${limit} n·∫øn cu·ªëi)\n`;
            candleDisplay += `API Type: ${getCurrentApiType().toUpperCase()}\n`;
            candleDisplay += `Gi√° hi·ªán t·∫°i: ${currentPrice}\n`;
            candleDisplay += `Thay ƒë·ªïi: ${priceChange}%\n`;
            candleDisplay += `C·∫≠p nh·∫≠t: ${new Date().toLocaleString('vi-VN')}\n\n`;
            candleDisplay += 'Th·ªùi gian | Open | High | Low | Close | Volume\n';
            candleDisplay += '‚îÄ'.repeat(60) + '\n';

            candleData.forEach(candle => {
                candleDisplay += `${candle.time} | ${candle.open} | ${candle.high} | ${candle.low} | ${candle.close} | ${candle.volume.toFixed(2)}\n`;
            });

            // T·∫°o prompt cho chatbot
            const tradingContext = document.getElementById('tradingContext').value;
            const technicalAnalysis = generateTechnicalAnalysis(candleData);

            let chatbotPrompt = `T√¥i c·∫ßn t∆∞ v·∫•n trading cho ${symbol}.\n\n`;
            chatbotPrompt += `=== TH√îNG TIN TRADING C·ª¶A T√îI ===\n${tradingContext}\n\n`;
            chatbotPrompt += `=== PH√ÇN T√çCH K·ª∏ THU·∫¨T ===\n${technicalAnalysis}\n\n`;
            chatbotPrompt += `=== D·ªÆ LI·ªÜU BI·ªÇU ƒê·ªí (${limit} n·∫øn cu·ªëi - khung ${timeframe}) ===\n`;

            // Ch·ªâ l·∫•y 10 n·∫øn cu·ªëi ƒë·ªÉ prompt kh√¥ng qu√° d√†i
            const recentCandles = candleData;
            recentCandles.forEach((candle, index) => {
                chatbotPrompt += `N·∫øn ${index + 1}: Open=${candle.open}, High=${candle.high}, Low=${candle.low}, Close=${candle.close}, Volume=${candle.volume.toFixed(2)}\n`;
            });
            chatbotPrompt += `\nB·∫°n l√† chuy√™n gia ph√¢n t√≠ch k·ªπ thu·∫≠t crypto. D·ª±a tr√™n d·ªØ li·ªáu tr√™n, h√£y t∆∞ v·∫•n cho t√¥i:\n`;
            // chatbotPrompt += `1. C√≥ n√™n gi·ªØ nguy√™n l·ªánh hi·ªán t·∫°i kh√¥ng?\n`;
            // chatbotPrompt += `2. C√≥ n√™n ƒëi·ªÅu ch·ªânh TP/SL kh√¥ng?\n`;
            // chatbotPrompt += `3. C√≥ c∆° h·ªôi v√†o l·ªánh m·ªõi kh√¥ng?\n`;
            // chatbotPrompt += `4. Risk management cho l·ªánh ti·∫øp theo\n`;
            // L·∫•y t·∫•t c·∫£ item ƒëang select
            const selectedAdvices = adviceList.filter(item => item.selected);

            // G·∫Øn n·ªôi dung v√†o chatbotPrompt
            selectedAdvices.forEach((item, index) => {
                chatbotPrompt += `${index + 1}. ${item.title} - ${item.desc}\n`;
            });

            document.getElementById('candleData').textContent = candleDisplay;
            document.getElementById('chatbotPrompt').textContent = chatbotPrompt;
        }

        function generateTechnicalAnalysis(candleData) {
            const currentCandle = candleData[candleData.length - 1];
            const prevCandle = candleData[candleData.length - 2] || currentCandle;

            // T√≠nh to√°n c√°c ch·ªâ s·ªë c∆° b·∫£n
            const priceChange = currentCandle.close - prevCandle.close;
            const priceChangePercent = ((priceChange / prevCandle.close) * 100).toFixed(2);

            // T√≠nh MA ƒë∆°n gi·∫£n
            const ma5 = candleData.slice(-5).reduce((sum, candle) => sum + candle.close, 0) / Math.min(5, candleData.length);
            const ma10 = candleData.slice(-10).reduce((sum, candle) => sum + candle.close, 0) / Math.min(10, candleData.length);

            // T√¨m high/low trong 20 n·∫øn g·∫ßn nh·∫•t
            const recent20 = candleData.slice(-20);
            const high20 = Math.max(...recent20.map(c => c.high));
            const low20 = Math.min(...recent20.map(c => c.low));

            let analysis = `Gi√° hi·ªán t·∫°i: ${currentCandle.close}\n`;
            analysis += `Thay ƒë·ªïi: ${priceChange} (${priceChangePercent}%)\n`;
            analysis += `MA5: ${ma5.toFixed(2)}\n`;
            analysis += `MA10: ${ma10.toFixed(2)}\n`;
            analysis += `High 20 n·∫øn: ${high20}\n`;
            analysis += `Low 20 n·∫øn: ${low20}\n`;

            // X√°c ƒë·ªãnh xu h∆∞·ªõng
            if (currentCandle.close > ma5 && ma5 > ma10) {
                analysis += `Xu h∆∞·ªõng: TƒÉng (Gi√° > MA5 > MA10)\n`;
            } else if (currentCandle.close < ma5 && ma5 < ma10) {
                analysis += `Xu h∆∞·ªõng: Gi·∫£m (Gi√° < MA5 < MA10)\n`;
            } else {
                analysis += `Xu h∆∞·ªõng: Sideway/Kh√¥ng r√µ r√†ng\n`;
            }

            return analysis;
        }

        function processManualData() {
            const manualDataText = document.getElementById('manualData').value.trim();
            const symbol = document.getElementById('coinSymbol').value.toUpperCase() || 'UNKNOWN';
            const timeframe = document.getElementById('timeframe').value;
            const limit = document.getElementById('candleLimit').value;

            if (!manualDataText) {
                showStatus('Vui l√≤ng nh·∫≠p d·ªØ li·ªáu JSON!', 'error');
                return;
            }

            try {
                showStatus('üîÑ ƒêang x·ª≠ l√Ω d·ªØ li·ªáu th·ªß c√¥ng...', 'loading');

                let data;
                try {
                    data = JSON.parse(manualDataText);
                } catch (parseError) {
                    throw new Error('D·ªØ li·ªáu JSON kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i format.');
                }

                // Check if it's MEXC Futures format (object with data property)
                if (data.success && data.data && data.data.time) {
                    console.log('Detected MEXC Futures format');
                    // Use Futures processing
                    const candleData = processCandleData(data, 'futures');
                    displayData(candleData, symbol, timeframe, limit);
                } else if (Array.isArray(data) && data.length > 0) {
                    console.log('Detected array format (likely Spot)');
                    // Check if first item is array (candlestick format)
                    const firstItem = data[0];
                    if (!Array.isArray(firstItem) || firstItem.length < 6) {
                        throw new Error('Format d·ªØ li·ªáu kh√¥ng ƒë√∫ng. M·ªói n·∫øn ph·∫£i c√≥ √≠t nh·∫•t 6 gi√° tr·ªã [timestamp, open, high, low, close, volume]');
                    }
                    // Use Spot processing
                    const candleData = processCandleData(data, 'spot');
                    displayData(candleData, symbol, timeframe, limit);
                } else {
                    throw new Error('ƒê·ªãnh d·∫°ng d·ªØ li·ªáu kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£. Vui l√≤ng paste d·ªØ li·ªáu t·ª´ MEXC API.');
                }

                showStatus('‚úÖ X·ª≠ l√Ω d·ªØ li·ªáu th·ªß c√¥ng th√†nh c√¥ng!', 'success');
                setTimeout(hideStatus, 3000);

            } catch (error) {
                console.error('Manual processing error:', error);
                showStatus(`‚ùå ${error.message}`, 'error');
            }
        }

        function refreshData() {
            fetchCandleData();
        }

        function copyData(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;

            navigator.clipboard.writeText(text).then(() => {
                showStatus('‚úÖ ƒê√£ copy v√†o clipboard!', 'success');
                setTimeout(hideStatus, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                showStatus('‚ùå Copy th·∫•t b·∫°i!', 'error');
            });
        }

        function copyAllData() {
            const candleData = document.getElementById('candleData').textContent;
            const chatbotPrompt = document.getElementById('chatbotPrompt').textContent;

            const allData = `=== D·ªÆ LI·ªÜU N·∫æN ===\n${candleData}\n\n=== PROMPT CHO CHATBOT ===\n${chatbotPrompt}`;

            navigator.clipboard.writeText(allData).then(() => {
                showStatus('‚úÖ ƒê√£ copy t·∫•t c·∫£ d·ªØ li·ªáu!', 'success');
                setTimeout(hideStatus, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                showStatus('‚ùå Copy th·∫•t b·∫°i!', 'error');
            });
        }

        // Load initial data khi DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            const savedApiType = localStorage.getItem("apiType");
            const savedCoinSymbol = localStorage.getItem("coinSymbol");
            const savedTimeframe = localStorage.getItem("timeframe");
            const savedCandleLimit = localStorage.getItem("candleLimit");

            // API Type
            if (savedApiType) {
                document.querySelectorAll(".api-type-btn").forEach(btn => {
                    btn.classList.toggle("active", btn.dataset.type === savedApiType);
                });
            }

            // Coin Symbol
            if (savedCoinSymbol) {
                document.getElementById("coinSymbol").value = savedCoinSymbol;
            }

            // Timeframe
            if (savedTimeframe) {
                document.getElementById("timeframe").value = savedTimeframe;
            }

            // Candle Limit
            if (savedCandleLimit) {
                document.getElementById("candleLimit").value = savedCandleLimit;
            }

            // === G·∫Øn s·ª± ki·ªán l∆∞u khi thay ƒë·ªïi ===

            // API Type buttons
            document.querySelectorAll(".api-type-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    document.querySelectorAll(".api-type-btn").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    localStorage.setItem("apiType", btn.dataset.type);
                });
            });

            // Coin Symbol
            document.getElementById("coinSymbol").addEventListener("input", e => {
                localStorage.setItem("coinSymbol", e.target.value);
            });

            // Timeframe
            document.getElementById("timeframe").addEventListener("change", e => {
                localStorage.setItem("timeframe", e.target.value);
            });

            // Candle Limit
            document.getElementById("candleLimit").addEventListener("input", e => {
                localStorage.setItem("candleLimit", e.target.value);
            });

            // L·∫•y tradingContext t·ª´ localStorage n·∫øu c√≥
            const savedContext = localStorage.getItem("tradingContext");
            if (savedContext) {
                document.getElementById('tradingContext').value = savedContext;
            }

            // L·∫•y tr·∫°ng th√°i adviceList t·ª´ localStorage n·∫øu c√≥
            const savedAdvice = localStorage.getItem("adviceList");
            if (savedAdvice) {
                const parsed = JSON.parse(savedAdvice);
                parsed.forEach((savedItem) => {
                    const item = adviceList.find(i => i.key === savedItem.key);
                    if (item) item.selected = savedItem.selected;
                });
            }

            renderAdvice();
        });

        // Khi tradingContext thay ƒë·ªïi ‚Üí l∆∞u l·∫°i
        function saveTradingContext() {
            const context = document.getElementById('tradingContext').value;
            localStorage.setItem("tradingContext", context);
        }

        const adviceList = [
            { key: "keep-position", title: "Gi·ªØ nguy√™n l·ªánh hi·ªán t·∫°i", desc: "C√≥ n√™n gi·ªØ nguy√™n c√°c l·ªánh ƒëang m·ªü kh√¥ng?", selected: true },
            { key: "adjust-tpsl", title: "ƒêi·ªÅu ch·ªânh TP/SL", desc: "C√≥ n√™n ƒëi·ªÅu ch·ªânh Take Profit v√† Stop Loss kh√¥ng?", selected: true },
            { key: "new-entry", title: "C∆° h·ªôi v√†o l·ªánh m·ªõi", desc: "C√≥ c∆° h·ªôi entry m·ªõi d·ª±a tr√™n ph√¢n t√≠ch k·ªπ thu·∫≠t kh√¥ng ( long v√† short )?", selected: true },
            { key: "risk-management", title: "Risk Management", desc: "Qu·∫£n l√Ω r·ªßi ro cho l·ªánh ti·∫øp theo", selected: true },
            { key: "market-sentiment", title: "T√¢m l√Ω th·ªã tr∆∞·ªùng", desc: "ƒê√°nh gi√° t√¢m l√Ω v√† xu h∆∞·ªõng t·ªïng th·ªÉ c·ªßa th·ªã tr∆∞·ªùng", selected: false },
            { key: "volume-analysis", title: "Ph√¢n t√≠ch kh·ªëi l∆∞·ª£ng", desc: "Ph√¢n t√≠ch volume v√† t√°c ƒë·ªông ƒë·∫øn gi√°", selected: false },
            { key: "support-resistance", title: "V√πng h·ªó tr·ª£/kh√°ng c·ª±", desc: "X√°c ƒë·ªãnh c√°c v√πng h·ªó tr·ª£ v√† kh√°ng c·ª± quan tr·ªçng", selected: false },
            { key: "scalping-opportunity", title: "C∆° h·ªôi scalping", desc: "T√¨m ki·∫øm c∆° h·ªôi giao d·ªãch ng·∫Øn h·∫°n trong ng√†y", selected: false }
        ];

        const adviceGrid = document.getElementById("adviceGrid");
        const selectAllBtn = document.getElementById("selectAllBtn");

        // Render list
        function renderAdvice() {
            adviceGrid.innerHTML = "";
            adviceList.forEach((item) => {
                const div = document.createElement("div");
                div.className = `advice-option ${item.selected ? "selected" : ""}`;
                div.dataset.advice = item.key;
                div.innerHTML = `
        <div class="advice-checkbox"></div>
        <div class="advice-text">
          <div class="advice-title">${item.title}</div>
          <div class="advice-description">${item.desc}</div>
        </div>
      `;
                // Click v√†o item th√¨ toggle selected
                div.addEventListener("click", () => {
                    item.selected = !item.selected;
                    saveAdviceList(); // L∆∞u l·∫°i m·ªói khi thay ƒë·ªïi
                    renderAdvice();
                });
                adviceGrid.appendChild(div);
            });
            updateSelectAllBtn();
        }

        // L∆∞u adviceList v√†o localStorage
        function saveAdviceList() {
            localStorage.setItem("adviceList", JSON.stringify(adviceList));
        }

        // C·∫≠p nh·∫≠t text n√∫t
        function updateSelectAllBtn() {
            const anySelected = adviceList.some(item => item.selected);
            selectAllBtn.textContent = anySelected ? "B·ªè t·∫•t c·∫£" : "Ch·ªçn t·∫•t c·∫£";
        }

        // Toggle Select All
        function toggleSelectAll() {
            const anySelected = adviceList.some(item => item.selected);
            adviceList.forEach(item => (item.selected = !anySelected));
            saveAdviceList();
            renderAdvice();
        }

        // G·∫Øn s·ª± ki·ªán change cho tradingContext (textarea/input)
        document.getElementById("tradingContext").addEventListener("input", saveTradingContext);
    </script>
</body>

</html>